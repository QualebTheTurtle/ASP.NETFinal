# ASP.NET MVC Tutorial Morosko Final

## Intro to MVC

### Overview

> In this lab We will go over what MVC is and create a website about dogs. This site includes features such as login and authentication, and even pages that only appear upon login. All of which can be easily maintained and reused through the awesomeness of MVC. 

### What is MVC????

> MVC stands for Model View Controler. It is an archetectural pattern, or a way to logically organize and structure programs. MVC is not a framework, however it is commonly used by many frameworks such as Ruby on Rails and Django. With MVC your program is organized in such a way that the Model is anything pertaining to the data of your program, being properties and databases. Views are anything pertaining to the "stuff" put out to the users screen. Finally Controller is for anything pertaining to processing information from user gathering info from the Model and View to create the final view and output to the user.

### MVC With ASP.NET And Web Development

>MVC can be related to the client server model in Web development. The user (you at your house) makes a request to a server, that server then requests information to a dataserver. The data server sends the requested information back and the server compiles a veiw to send to the user.
> 
>![alt text][img1]
>
>The senario above Is the same model with MVC applied where the user makes a request. The server controls the request, and gathers information from the model. The server then generates a view and reterns it to the user.

### Lets Get to It

Now that you understand the basics of MVC lets try to enforce MVC by creating an ASP.net web application using MVC. Were going to recreate the dog lab from earlier in the semester, but using MVC. To start open up Visual Studio and click file new Project, or press Ctrl+Shift+N.

![alt text][img2]

Fom there, in the left pane select templates, visual C#, finally web. 

![alt text][img3]

If you know git source control feel free to checkmark that box in the bottom right. Within the dialog box select the option circled below and name the project "DogzRRuff" in the text box at the bottom, and click Ok.

![alt text][img4]

From the template dialog box select MVC from the options in the top pane. You may also have host in the cloud checked, uncheck it. Click Ok to continue.

![alt text][img5]

Straight away we can see that Visual Studio has autogenerated a multitude of files and folders for us. Notice the Model, Views and Controller folders.

![alt text][img6]

MVC in Visual studio comes with alot of pre-built view's. Including login features and starting pages for home, about and contact. To start, lets run the code and take a look at what comes pre-built. To do this type Ctrl+F5. After viewing whats created by default lets make some changes to the homepage. Lets change the "Application name" homepage link in the top left to say DogzRRuff. 

![alt text][img7]

### Changing Application Name 

> To change the text for that open the solution explorer go to veiws and shared and open the \_Layout.cshtml. 
> 
> ![alt text][img8]
> 
> This is a Razor file. Raxor files end in .cshtml or .vbhtml and they are a mixture of C# or VB and HTML tags. Edit line 20 to 
> 
> ```csharp
> @Html.ActionLink("DogzRRuff", "Index", "Home", new { area = "" }, new { @class = "navbar-brand" })
> ```
> 
> Once edited hit Ctrl+Shift+B to rebuild the solution. Go to your web browser and refresh. From here we will change the words in our title and footer to reflect our new application name. Change lines 6 to
>
> ```csharp
> <title>@ViewBag.Title - DogzRRuff</title>
> ```
>
> and 36 to
>
> ```csharp
> <p>&copy; @DateTime.Now.Year - DogzRRuff</p>
> ```
>
> The website sould have the following changes after a build(Ctrl+Shift+B) and a refresh of your browser.
> 
> ![alt text][img9]
>

Were going to make the website look like this in the next section.

![alt text][img11]

### Changing the Home Page Content in MVC

> In MVC a view is created from a multitude of veiws or partial views. The view we edited previously is a partial view that all pages of the website share unless otherwize specified. Lets break that view down to better understand before we move on. At the top of the view there are normal HTML tags, going on we see an @ symbol. The @ denotes the usage of csharp. The first instance of an @ symbol that we see is on line 6
>
> ```csharp
>     <title>@ViewBag.Title - DogzRRuff</title>
> ```
>
> This line is an html title tag the csharp code after the @ symbol is ViewBag.Title this code creates a temporary variable called title that can be passed values from the partial view that is put in further down.
> The next line of intrest is line 33
>
> ```csharp
> @RenderBody()
> ```
>
> RenderBody function is a helper function that is implemented in MVC it is where the partial veiws to be passed in will be placed. Now that we understand the Shared partial veiw lets edit the body of the HomePage. To do this navigate to Views, Home, and opent the Index.cshtml file. 
> 
> ![alt text][img10]
> 
> This is the partial view that is output by the @RenderBody() function when we navigate to our localhost, or Localhost/home. Before we break the code down make it look like this
>
> ```csharp
>@{
>     ViewBag.Title = "Home Page";
> }
>
> <div class="jumbotron">
>     <h1>Dogz 'R' Ruff</h1>
>     <p>DogzRRuff is all about the dogs that have inpacted my life.</p> 
> </div>
> 
> <div class="row">
>    <div class="col-md-4">
>         <h2>Register With Us</h2>
>         <p>
>             To learn more about the good the bad and the ruff of my dogs create an account with us.
>         </p>
>         <p><a href="@Url.Action("Register", "Account")" class="btn btn-default btn-lg">Register</a></p>
>     </div>
>     <div class="col-md-4">
>         <h2>Login</h2>
>         <p>
>             If you already have an account please feel free to login.
>         </p>
>         <p><a href="@Url.Action("Login", "Account")" class="btn btn-default btn-lg">Login</a></p>
>     </div>
> </div>
> ```
> 
> The `@{ViewBag.Title = "Home Page";}` is our first line to break down. The @ indicates csharp code putting {} any code inbetween can be csharp. Whereas @ indicates a single line of csharp. As mentioned previously, setting ViewBag.Title to a string value passes that string value to the html title tag.
> 
> Moving on we see a div element with a class of jumbotron. One of the things that comes with MVC is Bootstrap, which is a front end component library that has alot of neat things that help HTML, CSS and Javascript to be easier and more responsive. We will not go into this in detail, however feel free to resarch at [W3Schools.com](http://www.w3schools.com). Jumbotron class creates a big grey box and any text inside is further exagerated.
>
>The next div includes two inner divs both if which are similar. The `@Url.Action()` function returns a Url when passed certain parameters. The first instance of this returns a url of "localhost/Accout/Register". This then opens the Register partial page within the @RenderBody() section of the shared \_Layout.cshtml file.
>
>Now that we better understand the changes we've made lets view them by pressing Ctrl+Shift+B to build our project and the refresh in our web browzer. If you see the image below then congragulations you now know the basics of editing Views in MVC. 
>
> ![alt text][img11]
>

Next were going to work with Models and controllers to change the register page slightly.

### Changing the Registers Page

> First were going to add a database to the project. There are many ways to do this, in MVC its easiest to create an account using the registers page. You will know you have a successful register when it redirects you to the home page and you can see your email and logout in the top right.
> 
> ![alt text][img12]
> 
> Once Created in visual studio in the App_Data Folder there should be a database file(red circle). To see this file you may have to press the view all files button(blue circle).
>
> ![alt text][img13]
>
> You will need to then open the package manager console and type "Enable-Migrations" and press enter.
>
> ![alt text][img14]
>
> Next we need to edit the identity model. Open the Models, IdentityModels.cs. Scroll down until you see the ApplicationUser class and add these properties to it.
>
> ```csharp
> public class ApplicationUser : IdentityUser
>    {
>         public string fName { get; set; }
>         public string lName { get; set; }   
>
>         public async Task<ClaimsIdentity> GenerateUserIdentityAsync(UserManager<ApplicationUser> manager)
>         {
>             // Note the authenticationType must match the one defined in CookieAuthenticationOptions.AuthenticationType
>             var userIdentity = await manager.CreateIdentityAsync(this, DefaultAuthenticationTypes.ApplicationCookie);
>            // Add custom user claims here
>             return userIdentity;
>         }
>     }
> ```
>
> Next go back to the Console and type "Add-Migration "fName"" hit enter.
>
> Then type "Update-Database" hit enter.
>
> Repeat the last two steps replacing fname in step 1 with lname. 
>
> Finally you have added first name and last name to the database to check double click the database file. In the Server Explorer window, select the tables dropdown then AspNetUsers and notice the fName and lName near the bottom.
> 
> ![alt text][img15]
>
> Next we need to edit the RegisterViewModel. This model has logic for any information that the user may send in a request from from that view. To get to the RegisterVeiwModel navigate to Models, AccountViewModel, RegisterViewModel.
> 
> ![alt text][img16]
> 
> Edit the RegisterViewModel class to look like below
>
> ```csharp
>     public class RegisterViewModel
>     {
>         [Required]
>         [Display(Name = "Username")]
>         public string Username { get; set; }
> 
>         [Required]
>         [Display(Name = "First Name")]
>         public string FirstName { get; set; }
> 
>         [Required]
>         [Display(Name = "Last Name")]
>         public string LastName { get; set; }
>
>         [Required]
>         [EmailAddress]
>         [Display(Name = "Email")]
>         public string Email { get; set; }
>
>         [Required]
>         [StringLength(100, ErrorMessage = "The {0} must be at least {2} characters long.", MinimumLength = 6)]
>         [DataType(DataType.Password)]
>         [Display(Name = "Password")]
>        public string Password { get; set; }
>
>         [DataType(DataType.Password)]
>         [Display(Name = "Confirm password")]
>         [Compare("Password", ErrorMessage = "The password and confirmation password do not match.")]
>         public string ConfirmPassword { get; set; }
>     }
>```
> 
> Now that weve edited the Model side of MVC we need to edit the Controler. To edit the controler for Register page we need to find the Register method that takes a parameter of a register view. To do this in Solution Explorer we can click Controllers, AccountController.cs, AccountController, Register(RegisterViewModel). Then edit the line that has the variable user, to look like below
>
> `var user = new ApplicationUser { UserName = model.Username, Email = model.Email, fName = model.FirstName, lName = model.LastName };`
>
> Next we need to change the view model for Register to have 3 new items for username, first name , and last name. Find the Register.cshtml using Solution Explorer and locate the div with the class form-group, copy it until the end div for that class it should be as much as below.
>
> ```csharp
>  <div class="form-group">
>        @Html.LabelFor(m => m.Email, new { @class = "col-md-2 control-label" })
>        <div class="col-md-10">
>            @Html.TextBoxFor(m => m.Email, new { @class = "form-control" })
>        </div>
>    </div>
> ```
>
> Paste the copied code above the first div form-group and edit it anywhere it says _m.Email_ to say _m.FirstName_. Paste 2 more blocks below the end div tag for the pasted block. Edit one to say m.LastName and the other to say m.Username. The additions above the first div form-group should appear as below
>
> ```csharp
>    <div class="form-group">
>       @Html.LabelFor(m => m.FirstName, new { @class = "col-md-2 control-label" })
>        <div class="col-md-10">
>            @Html.TextBoxFor(m => m.FirstName, new { @class = "form-control" })
>        </div>
>    </div>    
>    <div class="form-group">
>        @Html.LabelFor(m => m.LastName, new { @class = "col-md-2 control-label" })
>        <div class="col-md-10">
>            @Html.TextBoxFor(m => m.LastName, new { @class = "form-control" })
>        </div>
>    </div>    
>    <div class="form-group">
>        @Html.LabelFor(m => m.Username, new { @class = "col-md-2 control-label" })
>        <div class="col-md-10">
>            @Html.TextBoxFor(m => m.Username, new { @class = "form-control" })
>        </div>
>    </div>
> ```
>
> The code you have copied is razor with bootstrap to create a label control and a textbox coresponding to the label.
> At this point you can build your code and navigate to the register page and create a new account. Then try logging out and back in. Note once you've created a new account it redirects to the home page and your username is displayed in the top right.
>
>> #### We Broke the Login Page
>> Notice that if you logout and attempt to log back in you get an invalid login attempt with the correct information. This is due to the fact that we used the existing username field in the data base, and that is what the login authenticates off of. To fix this need to edit the account controler for login, in Solution Explorer navigate to Controllers, AccountController.cs, AccountController, Login(LoginViewModel, string) and make the code look like this 
>>
>> ```csharp
>>        // POST: /Account/Login
>>        [HttpPost]
>>        [AllowAnonymous]
>>        [ValidateAntiForgeryToken]
>>        public async Task<ActionResult> Login(LoginViewModel model, string returnUrl)
>>        {
>>            if (!ModelState.IsValid)
>>            {
>>                return View(model);
>>            }
>>
>>
>>            var db = new ApplicationDbContext();
>>
>>
>>            try
>>            {
>>                var user = db.Users.Where(u => u.Email.Equals(model.Email)).Single(); // where db is ApplicationDbContext instance
>>
>>                var result = await SignInManager.PasswordSignInAsync(user.UserName, model.Password, model.RememberMe, shouldLockout: false);
>>                // This doesn't count login failures towards account lockout
>>                // To enable password failures to trigger account lockout, change to shouldLockout: true
>>                //var result = await SignInManager.PasswordSignInAsync(model.Email, model.Password, model.RememberMe, shouldLockout: false);
>>                switch (result)
>>                {
>>                    case SignInStatus.Success:
>>                        return RedirectToLocal(returnUrl);
>>                    case SignInStatus.LockedOut:
>>                        return View("Lockout");
>>                    case SignInStatus.RequiresVerification:
>>                        return RedirectToAction("SendCode", new { ReturnUrl = returnUrl, RememberMe = model.RememberMe });
>>                    case SignInStatus.Failure:
>>                    default:
>>                        ModelState.AddModelError("", "Invalid login attempt.");
>>                        return View(model);
>>                }
>>            }
>>            catch (InvalidOperationException)
>>            {
>>                // the user is not exist
>>                ModelState.AddModelError("", "Invalid login attempt.");
>>                return View(model);
>>            }
>>
>>        }
>> ```
>>
>> To fix this issue we had to compare the users entry which is m.Email to the email in the database. We used the .users.where operators to do this. This is not the best approach for doing this, however it works and the bug is fixed for now. Next we will create a partial view to further modularize our shared files.

### Creating a Navigation Partial View

> Right click on views and select add and view. The add view window appears in viewname type "\_Navigation". Propernaming convention for partial views is to prefix the partial view with an underscore. Checkmark the box that says partial view, then verify your window looks like the image below and select ok.
>
> ![alt text][img17]
>
> This creates a \_Navigation.cshtml next were going to open the \_layout.cshtml and cut the out the navigation. Select from the `<div class="navbar navbar-inverse navbar-fixed-top">` to its matching /div, and pres Ctrl+X. Before pasting these, in the area that you just cut from, type this line of code `@Html.Partial("_Navigation")` This is the code that will call the navigation partial view. Finaly paste the coppied material in the \_Navigation.cshtml file. From now on any time you want to make a change to your normal navigation bar you would go to \_Navigation.

### Creating Pages That Display Only When Logged In

>First we need to create a controler to control the routing for our view. To do this right click Controllers select add and new Controller.
>
> ![alt text][img18]
>
>Then select the first option from the add Scafolding window. This creates an empty conroller for us to work with.
>
> ![alt text][img19]
>
> Name the Controller DogzController like below
>
> ![alt text][img20]
>
> Next edit the file to make it look like below
>
>```csharp
>using System;
>using System.Collections.Generic;
>using System.Linq;
>using System.Web;
>using System.Web.Mvc;
>
>namespace DogzRRuff.Controllers
>{
>    public class DogzController : Controller
>    {
>        [Authorize]
>        // GET: Dogz/Rusty
>        public ActionResult Rusty()
>        {
>            return View();
>        }
>    }
>}
> ```
>
> The `[Authorize]` statement makes it so the page accessed can only be viewed by logged in persons and redirects to the login page if not. `Action Result Rusty()` Creates the estention of the url that will be used in this case its Dogz/Rusty. This is from Dogz the name before Controller, and Rusty the name of the action result function. This functon returns the View() fuction. The View function searches for a folder in Views named Dogz and finds a cshtml file whos name matches the name of the action result function(Rusty), and creates a view from it.
>
> Next we must create the view for our controller to find in the Dogz folder. Notice in the Solution Explorer that a Dogz folder has already been created. this was created when we made the controller. Right click the Dogz folder and add a view (not a partial view) name it Rusty. Also create an images folder in your project and add a picture of a dog to it. Your code should look like this inside of the newly created view. <span>Note:<sub> `<img src"Your image link here"/>`</sub></span>
>
> ```csharp
> 
> @{
>     ViewBag.Title = "Rusty";
> }
> 
> <h2>My First Puppy</h2>
> <h3>Rusty</h3>
> <img src="~/Images/Rusty 2 300res.jpg" class="img-responsive center-block" />
> <br /> 
> <p>Rusty was my family dog from as far back as I can remember. He came into my family when I was in the 4th grade(2005/2006). He was always happy and super excited to see me and my faimily. Unfortinately he passed October 2017. He will be forever loved and for ever missed. Rest well Rusty.</p>
> ```
>
> From this point you should be able to build and refresh. To get to this page however you will need to type after localhost in the searchbar "/Dogz/rusty". Test both logged in and out. Next we will edit the nav bar to include a link to our page when we're logged in.

### Editing the nav bar
>First we need to open the \_LoginPartial.cshtml from Views, Shared. This partial view is the view that determines the content to display in the nav if a user is logedd in. Notice the partial view is an if statement that IfAuthenticated where it returns true if a person is logged in. Change the code underneath the if to say
>
> ```csharp
>    using (Html.BeginForm("LogOff", "Account", FormMethod.Post, new { id = "logoutForm", @class = "navbar-right" }))
>    {
>    @Html.AntiForgeryToken()
>
>    <ul class="nav navbar-nav navbar-right">
>        <li class="dropdown">
>                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Dogz
>                <span class="caret"></span>
>            </a>
>            <ul class="dropdown-menu">
>                <li><a href="#">@Html.ActionLink("Rusty", "Rusty", "Dogz")</a></li>
>            </ul>
>        </li>
>        <li>
>            @Html.ActionLink("Hello " + User.Identity.GetUserName() + "!", "Index", "Manage", routeValues: null, htmlAttributes: new { title = "Manage" })
 >       </li>
 >       <li><a href="javascript:document.getElementById('logoutForm').submit()">Log off</a></li>
 >   </ul>
 >   }
 > ```
 >
 > In this we've changed the ul for the right side of the navigation bar to have another li. Using bootstrap we have created a dropdown so if we wanted to add another dog we could easily add it to the dropdown-menu li. Build and refresh the page. Congragulations! You understand the basics of MVC in ASP.NET. Pat yourself on the back this is no small task at all. Please take it one step further and try it yourself. Refrain from viewing the answer. 
 
 ### Do It Yourself
 
 > Add another authenticated function to our controller to navigate the user to Dogz/Delilah. Then create a partial view similar to the one created for Rusty, call it Delilah. Finaly add a @Html.action to the dropdown-menu for Dogz in the \_LoginPartial file to give the user a link to navigate to your page. Build and refresh to check your work. Don't cheat!!!!
 
 ## Warning The Following Is The Answer
 
Controller

 ```csharp
 using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Web.Mvc;

namespace DogzRRuff.Controllers
{
    public class DogzController : Controller
    {
        [Authorize]
        // GET: Dogz/Rusty
        public ActionResult Rusty()
        {
            return View();
        }

        [Authorize]
        // GET: Dogz/Delilah
        public ActionResult Delilah()
        {
            return View();
        }
    }
}
```
 
View
 
```csharp
 
@{
    ViewBag.Title = "Delilah";
}

<h2>My Other Puppy</h2>
<h3>Delilah</h3>
<img src="~/Images/7427.jpeg" class="img-responsive center-block" />
<br />
<p>Delilah was a young pup when my girl friend got her in summer 2015. She is now a helathy, happy, hyper puppy and helps to fill the hole that rusty left in his passing.</p>


 ```
 
Navigation

```csharp
 @using Microsoft.AspNet.Identity
 @if (Request.IsAuthenticated)
 {
     using (Html.BeginForm("LogOff", "Account", FormMethod.Post, new { id = "logoutForm", @class = "navbar-right" }))
     {
     @Html.AntiForgeryToken()
 
     <ul class="nav navbar-nav navbar-right">
         <li class="dropdown">
                 <a href="#" class="dropdown-toggle" data-toggle="dropdown">Dogz
                 <span class="caret"></span>
             </a>
             <ul class="dropdown-menu">
                 <li><a href="#">@Html.ActionLink("Rusty", "Rusty", "Dogz")</a></li>
                 <li><a href="#">@Html.ActionLink("Delilah", "Delilah", "Dogz")</a></li>
             </ul>
         </li>
         <li>
             @Html.ActionLink("Hello " + User.Identity.GetUserName() + "!", "Index", "Manage", routeValues: null, htmlAttributes: new { title = "Manage" })
         </li>
         <li><a href="javascript:document.getElementById('logoutForm').submit()">Log off</a></li>
     </ul>
     }
 }
 else
 {
     <ul class="nav navbar-nav navbar-right">
         <li>@Html.ActionLink("Register", "Register", "Account", routeValues: null, htmlAttributes: new { id = "registerLink"     })</li>
         <li>@Html.ActionLink("Log in", "Login", "Account", routeValues: null, htmlAttributes: new { id = "loginLink" })</li>
     </ul>
 }
```

[img1]: img/MVCDiagram.jpg "Tutorial img 1 shows a visual helpper of MVC. Created by Caleb Wagner using Microsoft Visio."
[img2]: img/Step1.png "Tutorial img 2 shows a visual of above text. Created by Caleb Wagner."
[img3]: img/Step2.png "Tutorial img 3 shows a visual of above text. Created by Caleb Wagner."
[img4]: img/Step3.png "Tutorial img 4 shows a visual of above text. Created by Caleb Wagner."
[img5]: img/Step4.png "Tutorial img 5 shows a visual of above text. Created by Caleb Wagner."
[img6]: img/Step5.png "Tutorial img 6 shows a visual of above text. Created by Caleb Wagner."
[img7]: img/Step6.png "Tutorial img 7 shows a visual of above text. Created by Caleb Wagner."
[img8]: img/Step7.png "Tutorial img 8 shows a visual of above text. Created by Caleb Wagner."
[img9]: img/Step8.png "Tutorial img 9 shows a visual of above text. Created by Caleb Wagner."
[img10]: img/Step9.png "Tutorial img 10 shows a visual of above text. Created by Caleb Wagner."
[img11]: img/Step10.png "Tutorial img 11 shows a visual of above text. Created by Caleb Wagner."
[img12]: img/Step11.png "Tutorial img 12 shows a visual of above text. Created by Caleb Wagner."
[img13]: img/Step12.png "Tutorial img 13 shows a visual of above text. Created by Caleb Wagner."
[img14]: img/Step13.png "Tutorial img 14 shows a visual of above text. Created by Caleb Wagner."
[img15]: img/Step14.png "Tutorial img 15 shows a visual of above text. Created by Caleb Wagner."
[img16]: img/Step15.png "Tutorial img 16 shows a visual of above text. Created by Caleb Wagner."
[img17]: img/Step16.png "Tutorial img 17 shows a visual of above text. Created by Caleb Wagner."
[img18]: img/Step17.png "Tutorial img 18 shows a visual of above text. Created by Caleb Wagner."
[img19]: img/Step18.png "Tutorial img 19 shows a visual of above text. Created by Caleb Wagner."
[img20]: img/Step19.png "Tutorial img 20 shows a visual of above text. Created by Caleb Wagner."
